@page "/clients/{ClientId:int}/edit/"
@page "/clients/create/"
@inherits Blazor.Fluxor.Components.FluxorComponent
@implements IDisposable
@inject IDispatcher Dispatcher
@inject IState<FullStackSample.Client.Store.ClientCreate.ClientCreateState> State

<nav aria-label="Breadcrumb">
	<ol class="breadcrumb">
		<li class="breadcrumb-item">
			<a href="/clients/search/">Clients</a>
		</li>
		<li class="breadcrumb-item active">
			@ActionText
		</li>
	</ol>
</nav>
@if (!string.IsNullOrEmpty(State.Value.ErrorMessage))
{
	<div class="alert alert-danger" role="alert">
		@State.Value.ErrorMessage
	</div>
}
<EditForm Model=@FormData OnValidSubmit=@Submit>
	<PeterLeslieMorris.Blazor.Validation.Validate />
	<div class="form-group">
		<label for="Name">Name</label>
		<InputText @bind-Value=FormData.Name Class="form-control" aria-describedby="Name" @attributes=GetElementDisabled() />
		<ValidationMessage For=@(() => FormData.Name) />
	</div>
	<div class="form-group">
		<label for="RegistrationNumber">Registration number</label>
		<InputNumber @bind-Value=FormData.RegistrationNumber Class="form-control" aria-describedby="Registration number" @attributes=GetElementDisabled() />
		<ValidationMessage For=@(() => FormData.RegistrationNumber) />
	</div>
	<button type="submit" class="btn btn-primary" @attributes=@GetElementDisabled()>
		@(State.Value.IsExecutingApi ? ActionInProgressText : SubmitText)
	</button>
</EditForm>

@code {
	[Parameter] public int? ClientId { get; set; }
	bool IsNew => !ClientId.HasValue;
	string ActionText => IsNew ? "Create" : "Edit";
	string SubmitText => IsNew ? "Create" : "Save";
	string ActionInProgressText => IsNew ? "Creating..." : "Saving...";

	FullStackSample.Api.Models.ClientCreateOrUpdate FormData;

	void Submit()
	{
		var command = new Api.Requests.ClientCreateCommand(FormData);
		Dispatcher.Dispatch(command);
	}

	void UpdateFormState(object feature, FullStackSample.Client.Store.ClientCreate.ClientCreateState state)
	{
		System.Diagnostics.Debug.WriteLine("FormData updated");
		FormData = new FullStackSample.Api.Models.ClientCreateOrUpdate(
			id: state.Client.Id,
			name: state.Client.Name,
			registrationNumber: state.Client.RegistrationNumber);
	}

	Dictionary<string, object> GetElementDisabled()
	{
		if (State.Value.IsExecutingApi)
			return new Dictionary<string, object> { ["disabled"] = "disabled" };
		return new Dictionary<string, object>();
	}

	protected override void OnInitialized()
	{
		FormData = new Api.Models.ClientCreateOrUpdate();
		this.State.StateChanged += UpdateFormState;
	}

	public async override Task SetParametersAsync(ParameterView parameters)
	{
		await base.SetParametersAsync(parameters);
		if (ClientId.HasValue)
			System.Diagnostics.Debug.WriteLine("Editing " + ClientId);
	}

	void IDisposable.Dispose()
	{
		this.State.StateChanged -= UpdateFormState;
	}
}